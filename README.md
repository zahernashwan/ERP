# ERP Solution — Clean Architecture Structure

## Quick start

المتطلبات: .NET SDK 8

### Build

```bash
dotnet build -c Release
```

### Run

نقطة التشغيل المفضلة (Composition Root):

```bash
dotnet run --project src/ERP.Bootstrapper
```

### Test

```bash
dotnet test -c Release
```

## نظرة عامة للمبرمجين الجدد

هذا المستودع عبارة عن حل (.NET 8) مبني بأسلوب **Clean Architecture** مع WinForms كواجهة مستخدم.

## هدف حل ERP

هدف هذا الحل هو بناء نظام ERP مكتبي (WinForms) قابل للتوسع والصيانة، يغطي دورة العمل الأساسية للشركات عبر وحدات مترابطة تشمل:

- **التهيئة**: إعداد متغيرات النظام، الفترات، العملات، الدول/المدن، بيانات الشركة والفروع، الدليل المحاسبي، مراكز التكلفة، وإعدادات المخزون/الموردين/العملاء.
- **المدخلات**: إدخال البيانات المرجعية (الموظفين، الصناديق والبنوك، الأرصدة الافتتاحية، الأصناف والمخازن، الموردين والعملاء…).
- **العمليات**: تنفيذ العمليات اليومية (قيود/سندات/إشعارات، أوامر توريد/صرف/تحويل، مشتريات/مبيعات، ترحيل/إقفال…).
- **التقارير**: تقارير الحسابات والمخزون والمشتريات والمبيعات.
- **إدارة النظام**: المستخدمون والصلاحيات والنسخ الاحتياطي/الاسترجاع.

### شجرة الوظائف (Functional Map)

> ملاحظة: هذه الشجرة تُستخدم كمرجع نطاق (Scope) للمنتج. التنفيذ الحالي قد يغطي جزءًا منها ويتوسع تدريجيًا.

```
ERP
│
├─ التهيئة
│  │
│  ├─ تهيئة النظام
│  │  ├─ المتغيرات العامة
│  │  ├─ فترات النظام
│  │  ├─ العملات
│  │  │  ├─ تهيئة العملات
│  │  │  └─ إضافة عملة أجنبية
│  │  ├─ صلاحية المخزون
│  │  ├─ الأقاليم والدول
│  │  │  ├─ الدول
│  │  │  ├─ المحافظات
│  │  │  ├─ المدن
│  │  │  └─ المناطق
│  │  ├─ بيانات الشركة
│  │  ├─ بيانات الفروع
│  │  ├─ الدليل المحاسبي
│  │  └─ مراكز التكلفة
│  │
│  ├─ تهيئة أنظمة الحسابات
│  │  └─ متغيرات الأستاذ العام
│  │
│  ├─ تهيئة أنظمة المخازن
│  │  ├─ متغيرات المخزون
│  │  ├─ وحدات القياس
│  │  ├─ مستويات التسعيرة
│  │  ├─ أنواع التوريد
│  │  ├─ أنواع الصرف
│  │  └─ أنواع التحويل
│  │
│  ├─ تهيئة أنظمة الموردين
│  │  ├─ متغيرات الموردين
│  │  ├─ تهيئة المشتريات
│  │  └─ طرق التكاليف
│  │
│  └─ تهيئة نظام العملاء
│     └─ متغيرات العملاء
│
├─ المدخلات
│  │
│  ├─ مدخلات النظام
│  │  ├─ الهيكل الإداري
│  │  ├─ بيانات الموظفين
│  │  ├─ الحسابات الوسيطة
│  │  └─ مراكز التكلفة
│  │
│  ├─ مدخلات الحسابات
│  │  ├─ الصناديق
│  │  ├─ البنوك
│  │  └─ الأرصدة الافتتاحية (حسابات)
│  │
│  ├─ مدخلات المخازن
│  │  ├─ المجموعات الرئيسية
│  │  ├─ مجموعات المخازن
│  │  ├─ المخازن
│  │  ├─ الأرفف
│  │  ├─ الأصناف
│  │  ├─ ملحقات الأصناف
│  │  ├─ الأصناف المركبة
│  │  ├─ تسعيرة الأصناف
│  │  ├─ المخزون الافتتاحي
│  │  └─ ربط المخزون بالأستاذ العام
│  │
│  ├─ مدخلات الموردين
│  │  ├─ مجموعات الموردين
│  │  └─ الموردين
│  │
│  └─ مدخلات العملاء
│     ├─ مجموعات العملاء
│     └─ العملاء
│
├─ العمليات
│  │
│  ├─ عمليات الحسابات
│  │  ├─ سند صرف نقدي
│  │  ├─ سند صرف شيك
│  │  ├─ سند قبض نقدي
│  │  ├─ سند قبض شيك
│  │  ├─ القيود اليومية
│  │  ├─ طلب قيد يومية
│  │  ├─ إشعار مدين
│  │  ├─ إشعار دائن
│  │  └─ صرف عملة
│  │
│  ├─ عمليات المخزون
│  │  ├─ أمر توريد مخزني
│  │  ├─ أمر صرف مخزني
│  │  ├─ تحويل مخزني
│  │  ├─ استلام تحويل
│  │  ├─ تسوية مخزون
│  │  └─ جرد المخزون
│  │
│  ├─ إدارة المشتريات
│  │  ├─ فاتورة مشتريات محلية
│  │  ├─ فاتورة مشتريات خارجية
│  │  ├─ أوامر الشراء
│  │  ├─ مرتجع مشتريات
│  │  └─ اعتماد مستندي
│  │
│  ├─ إدارة المبيعات
│  │  ├─ فاتورة مبيعات
│  │  └─ مردود مبيعات
│  │
│  └─ المراجعة والترحيلات
│     ├─ اعتماد الوثائق
│     ├─ الترحيل
│     ├─ إلغاء الترحيل
│     └─ الإقفال الشهري
│
├─ التقارير
│  ├─ تقارير الحسابات
│  │  ├─ الأستاذ العام
│  │  └─ ميزان المراجعة
│  ├─ تقارير المخزون
│  ├─ تقارير المشتريات
│  └─ تقارير المبيعات
│
└─ إدارة النظام
   ├─ المستخدمون
   ├─ الصلاحيات
   │  ├─ صلاحيات الشاشات
   │  └─ صلاحيات العمليات
   ├─ تغيير كلمة المرور
   ├─ النسخ الاحتياطي
   └─ استرجاع نسخة احتياطية
```

### خريطة المشاريع (أين تضع الكود؟)

| المشروع | المسار | ماذا يحتوي؟ |
| --- | --- | --- |
| `ERP.Domain` | `src/ERP.Domain` | نموذج الأعمال: Aggregates/Entities/Value Objects/Domain Events + invariants |
| `ERP.Application` | `src/ERP.Application` | حالات الاستخدام (Use Cases) بصيغة CQRS خفيفة + حدود المعاملات (`IUnitOfWork`) + واجهات المستودعات |
| `ERP.Infrastructure` | `src/ERP.Infrastructure` | تنفيذات تقنية لواجهات Application (حاليًا In-Memory) + تسجيلها بالـ DI |
| `ERP.Presentation.WinForms` | `src/ERP.Presentation.WinForms` | الواجهة WinForms (Forms + Controllers) بدون منطق أعمال |
| `ERP.Bootstrapper` | `src/ERP.Bootstrapper` | نقطة التشغيل/Composition Root: تجميع الطبقات (DI) ثم تشغيل `MainForm` |

### اتجاه الاعتمادات (المسموح فقط)

```
Presentation  -> Application -> Domain
Infrastructure -> Application -> Domain
```

قواعد سريعة:
- `Domain` لا يعتمد على أي طبقة.
- `Application` يعتمد على `Domain` فقط ويعرّف واجهات البنية التحتية (مثل Repositories و `IUnitOfWork`).
- `Infrastructure` ينفّذ هذه الواجهات.
- `Presentation.WinForms` يتعامل مع `Application` عبر Handlers/Use Cases، ولا يصل للبنية التحتية مباشرة.

### نقطة التشغيل (Entrypoint)

المشروع المعتمد للتشغيل هو `ERP.Bootstrapper` لأنه الـ Composition Root.

```bash
dotnet run --project src/ERP.Bootstrapper
```

### الاختبارات

| المشروع | ماذا يختبر؟ |
| --- | --- |
| `tests/ERP.Domain.Tests` | سلوك الـ Domain والـ invariants |
| `tests/ERP.Application.Tests` | تنسيق حالات الاستخدام (handlers) والتكامل مع الـ repositories/UnitOfWork |
| `tests/ERP.ArchitectureGuard` | حراسة الحدود المعمارية (منع اعتمادات غير مسموحة بين الطبقات) |

تشغيل الكل:

```bash
dotnet test -c Release
```

### ملاحظات مهمة عن Application layer (الحالة الحالية)

- يوجد MediatR مسجّل عبر `ApplicationModule.AddApplication(IServiceCollection)`.
- لكن الـ use-case handlers حاليًا **لا تطبّق** `IRequestHandler`؛ يتم استدعاء `HandleAsync(...)` مباشرة.
- عند التحول لاحقًا إلى MediatR بشكل كامل، الهدف هو إرسال Commands/Queries عبر `ISender`.

هذا الحل يتبع **Clean Architecture** بشكل صارم، ويقسم النظام إلى أربع طبقات واضحة. كل طبقة لها مسؤوليات محددة وحدود صارمة، واتجاه الاعتمادات يكون نحو الداخل فقط.

## الطبقات الأربع

### 1) Domain (ERP.Domain)
**المسؤوليات**
- تمثيل نموذج الأعمال (Entities / Value Objects / Aggregates عند الحاجة).
- فرض القواعد والقيود الجوهرية داخل حدود الـ Aggregate فقط.
- إصدار Domain Events لوصف أحداث الأعمال ذات المعنى.

**الحدود الصارمة**
- لا أطر عمل، لا بنية تحتية، لا واجهات مستخدم، ولا تخزين بيانات.
- لا يحتوي على منطق حالات استخدام أو تنسيق عمليات.

### 2) Application (ERP.Application)
**المسؤوليات**
- تنسيق حالات الاستخدام (Use Cases) وحدود المعاملات.
- تطبيق CQRS خفيف: **Commands تُغيّر الحالة**، **Queries لا تُغيّر الحالة**.
- الحفاظ على الاتساق بين الـ Aggregates واستهلاك Domain Events لتفعيل سير العمل.

**الحدود الصارمة**
- لا قواعد أعمال جوهرية (توجد في Domain فقط).
- لا تنفيذات تقنية أو تعامل مباشر مع البنية التحتية.

### 3) Infrastructure (ERP.Infrastructure)
**المسؤوليات**
- تنفيذ التفاصيل التقنية: قواعد البيانات، الرسائل، نظام الملفات، والخدمات الخارجية.
- توفير تطبيقات الواجهات (Interfaces) المعرفة في الداخل.

**الحدود الصارمة**
- لا منطق أعمال أو قواعد نطاق.
- تعتمد للداخل فقط ويمكن استبدالها بسهولة.

### 4) Presentation (ERP.Presentation.WinForms)
**المسؤوليات**
- عرض البيانات للمستخدم عبر WinForms.
- اتباع Supervising Controller / Passive View.
- الـ Controllers تنسق حالات الاستخدام وتحدّث الـ Views.

**الحدود الصارمة**
- لا منطق أعمال، لا قواعد نطاق، ولا وصول مباشر للبنية التحتية.

## اتجاه الاعتمادات المسموح فقط
الاعتمادات تتجه نحو الداخل:

```
Presentation -> Application -> Domain
Infrastructure -> Application -> Domain
```

- **Domain** لا يعتمد على أي طبقة أخرى.
- **Application** يعتمد على Domain فقط.
- **Infrastructure** و **Presentation** يعتمدان على Application و/أو Domain لكن لا العكس.

## ملاحظات معمارية أساسية
- القواعد التجارية دائماً في Domain.
- التغييرات في البنية التحتية أو الواجهة لا يجب أن تؤثر على Domain.
- يتم حقن جميع الاعتمادات صراحةً دون Service Locators.
