name: Cleanup GitHub Actions Runs

on:
  workflow_dispatch:

permissions:
  actions: write

jobs:
  cleanup:
    name: ðŸ§¹ Delete All Workflow Runs
    runs-on: ubuntu-latest

    steps:
      - name: Delete all workflow runs
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            let deleted = 0;

            // Always fetch page 1 since deletions shift remaining runs forward
            while (deleted < 500) {
              const { data: { workflow_runs: runs } } = await github.rest.actions.listWorkflowRunsForRepo({
                owner,
                repo,
                per_page: 100,
                page: 1,
              });

              if (runs.length === 0) break;

              // Stop if the only remaining run is the current one
              if (runs.length === 1 && runs[0].id === context.runId) break;

              for (const run of runs) {
                // Skip the current cleanup run
                if (run.id === context.runId) continue;

                try {
                  await github.rest.actions.deleteWorkflowRun({
                    owner,
                    repo,
                    run_id: run.id,
                  });
                  deleted++;
                  core.info(`Deleted run ${run.id} (${run.name} #${run.run_number})`);
                } catch (err) {
                  core.warning(`Failed to delete run ${run.id}: ${err.message}`);
                }
              }
            }

            core.info(`Total runs deleted: ${deleted}`);

      - name: Verify remaining runs
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { data: { total_count } } = await github.rest.actions.listWorkflowRunsForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              per_page: 1,
            });

            // Subtract 1 for the currently running cleanup workflow
            const remaining = Math.max(total_count - 1, 0);
            core.info(`Remaining workflow runs: ${remaining}`);

            if (remaining > 0) {
              core.warning(`${remaining} runs still remain. Re-run this workflow to continue cleanup.`);
            } else {
              core.info('All historical workflow runs have been deleted.');
            }
